apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: deployment-replicas
spec:
  matchConstraints:
    matchPolicy: "Equivalent"
    namespaceSelector: {}
    objectSelector: {}
    resourceRules:
    - apiGroups: ["*"]
      apiVersions: ["v1"]
      operations: ["CREATE", "UPDATE"]
      resources: ["deployments"]
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  variables:
  - name: annotations
    expression: "has(namespaceObject.metadata.annotations) ? namespaceObject.metadata.annotations : {}"
  - name: maxReplicas
    expression: "'max-replicas' in variables.annotations ? int(variables.annotations['max-replicas']) : 0"
  mutations:
  - patchType: ApplyConfiguration
    applyConfiguration:
      expression: >-
        Object{
          spec: Object.spec {
            replicas: variables.maxReplicas
          }
        }
